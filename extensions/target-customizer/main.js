import{DataProvider as t,RenderEngine as e,StringLoader as n}from"../../core.min.js";const r={iconPath:{wave:'<path d="M22.768125 12.478124999999999c-2.15625 4.59375 -4.03125 6.6468750000000005 -6.076874999999999 6.6468750000000005 -2.59125 0 -4.106249999999999 -3.22875 -5.709375 -6.6468750000000005 -0.6693749999999999 -1.43625 -1.3696875 -2.9156250000000004 -2.083125 -3.9721874999999995C8.2865625 7.6021875 7.7371875 7.125 7.3125 7.125c-0.35812499999999997 0 -1.71 0.38625 -4.0396875 5.353125a1.125 1.125 0 0 1 -2.0371875 -0.9562499999999999c2.15625 -4.59375 4.03125 -6.6468750000000005 6.076874999999999 -6.6468750000000005 2.59125 0 4.106249999999999 3.22875 5.709375 6.6468750000000005 0.6740625 1.43625 1.3696875 2.9203124999999996 2.083125 3.9721874999999995 0.6121875 0.90375 1.1615625 1.3809375 1.59375 1.3809375 0.35812499999999997 0 1.71 -0.38625 4.0396875 -5.353125a1.125 1.125 0 0 1 2.0371875 0.9562499999999999Z"></path>',flatline:'<path d="M2 12C2 11.4477 2.44772 11 3 11H21C21.5523 11 22 11.4477 22 12C22 12.5523 21.5523 13 21 13H3C2.44772 13 2 12.5523 2 12Z"></path>',tilted:'<path d="M12.5935 23.2578l-0.0116 0.0017 -0.071 0.0355 -0.019 0.0037 -0.0152 -0.0037 -0.071 -0.0355c-0.0099 -0.0031 -0.0187 -0.0005 -0.0236 0.0054l-0.0041 0.0109 -0.0171 0.4273 0.005 0.0204 0.011 0.0122 0.1036 0.074 0.0148 0.0039 0.0118 -0.0039 0.1036 -0.074 0.0126 -0.016 0.0034 -0.0166 -0.0171 -0.4273c-0.002 -0.0101 -0.0086 -0.0165 -0.0161 -0.018Zm0.2649 -0.1125 -0.0139 0.002 -0.1847 0.0924 -0.0099 0.0102 -0.0027 0.0112 0.0179 0.4295 0.0048 0.0128 0.0085 0.0071 0.2009 0.0927c0.0121 0.0037 0.0229 -0.0002 0.0285 -0.008l0.004 -0.014 -0.0341 -0.6147c-0.0024 -0.0119 -0.0103 -0.0195 -0.0193 -0.0212Zm-0.7154 0.002c-0.0098 -0.0049 -0.0208 -0.002 -0.0274 0.0053l-0.0057 0.0139 -0.0341 0.6147c-0.0007 0.0115 0.007 0.0207 0.0168 0.0234l0.0157 -0.0014 0.2009 -0.0927 0.0094 -0.0081 0.0039 -0.0118 0.0179 -0.4295 -0.0032 -0.0126 -0.0094 -0.0088 -0.1848 -0.0924Z" stroke-width="5"></path><path d="M20.7071 3.29289c0.3905 0.39053 0.3905 1.02369 0 1.41422L4.70711 20.7071c-0.39053 0.3905 -1.02369 0.3905 -1.41422 0 -0.39052 -0.3905 -0.39052 -1.0237 0 -1.4142L19.2929 3.29289c0.3905 -0.39052 1.0237 -0.39052 1.4142 0Z" stroke-width="5"></path>'},Icon(t){return`\n    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"\n      style="width: 1.5rem; height: 1.5rem;"\n    >\n      ${this.iconPath[t]}\n    </svg>\n    `}};class Equalizer{constructor(){this.config={DefaultSampleRate:48e3}}_lowshelf(t,e,n){t/=this.config.DefaultSampleRate,t=Math.max(1e-6,Math.min(t,1)),e=Math.max(1e-4,Math.min(e,1e3)),n=Math.max(-40,Math.min(n,40));let r=2*Math.PI*t,i=Math.sin(r),a=Math.cos(r),o=Math.pow(10,n/40),l=i/(2*e),s=2*Math.sqrt(o)*l||0,c=o+1+(o-1)*a+s;return[1,-2*(o-1+(o+1)*a)/c,(o+1+(o-1)*a-s)/c,o*(o+1-(o-1)*a+s)/c,2*o*(o-1-(o+1)*a)/c,o*(o+1-(o-1)*a-s)/c]}_highshelf(t,e,n){t/=this.config.DefaultSampleRate,t=Math.max(1e-6,Math.min(t,1)),e=Math.max(1e-4,Math.min(e,1e3)),n=Math.max(-40,Math.min(n,40));let r=2*Math.PI*t,i=Math.sin(r),a=Math.cos(r),o=Math.pow(10,n/40),l=i/(2*e),s=2*Math.sqrt(o)*l||0,c=o+1-(o-1)*a+s;return[1,2*(o-1-(o+1)*a)/c,(o+1-(o-1)*a-s)/c,o*(o+1+(o-1)*a+s)/c,-2*o*(o-1+(o+1)*a)/c,o*(o+1+(o-1)*a-s)/c]}_peaking(t,e,n){t/=this.config.DefaultSampleRate,t=Math.max(1e-6,Math.min(t,1)),e=Math.max(1e-4,Math.min(e,1e3)),n=Math.max(-40,Math.min(n,40));let r=2*Math.PI*t,i=Math.sin(r),a=Math.cos(r),o=i/(2*e),l=Math.pow(10,n/40),s=1+o/l;return[1,-2*a/s,(1-o/l)/s,(1+o*l)/s,-2*a/s,(1-o*l)/s]}_calculateGains(t,e){let n=new Array(t.length).fill(0);for(let r=0;r<e.length;++r){let[i,a,o,l,s,c]=e[r];for(let e=0;e<t.length;++e){let r=2*Math.PI*t[e]/this.config.DefaultSampleRate,d=4*Math.pow(Math.sin(r/2),2),u=10*Math.log10(Math.pow(l+s+c,2)+(l*c*d-(s*(l+c)+4*l*c))*d)-10*Math.log10(Math.pow(i+a+o,2)+(i*o*d-(a*(i+o)+4*i*o))*d);n[e]+=u}}return n}_filtersToCoeffs(t){return t.map((t=>t.freq&&t.gain&&t.q?"LSQ"===t.type?this._lowshelf(t.freq,t.q,t.gain):"HSQ"===t.type?this._highshelf(t.freq,t.q,t.gain):"PK"===t.type?this._peaking(t.freq,t.q,t.gain):null:null)).filter((t=>t))}applyFilters(t,e){let n=t.map((t=>t[0])),r=this._filtersToCoeffs(e),i=this._calculateGains(n,r);return n.map(((e,n)=>[e,t[n][1]+i[n]]))}}const i={name:"target-customizer",version:"1.0.0",apiLevel:1,coreMinVersion:"1.0.0",coreMaxVersion:"1.0.x",description:"Target curve customization extension with filter support",author:"potatosalad775"};class TargetCustomizer{constructor(t={}){this.config=t,this.customizableTargetList=this._getCustomizableTargetList()||[],this.availableFilters=this.config.FILTERS||[],this.currentTarget=new Map,this.observer=null,this._init()}_init(){this.selectionList=document.querySelector(".selection-list");const n=document.createElement("style");n.textContent='\n  .target-control-component {\n    display: block;\n    margin: 0.5rem;\n    margin-top: 0;\n    container: tc-container / inline-size;\n    max-height: 1000px;\n    overflow: hidden;\n    transition: max-height 0.3s ease-in-out, margin 0.3s ease-in-out, opacity 0.2s ease-in-out;\n    opacity: 1;\n  }\n\n  .target-control-component.tc-component-hidden {\n    max-height: 0;\n    margin: 0 0.5rem;\n    opacity: 0;\n    pointer-events: none;\n  }\n\n  .tc-container {\n    display: flex;\n    flex-direction: column;\n    gap: 0.75rem;\n  }\n\n  .tc-filters-section {\n    display: flex;\n    flex-direction: column;\n    gap: 0.5rem;\n    padding: 0.625rem;\n    border-radius: 0.5rem;\n    background: var(--gt-color-tertiary-container);\n    border: 1px solid var(--gt-color-outline-variant);\n  }\n\n  .tc-section-title {\n    font: var(--gt-typescale-label-large);\n    color: var(--gt-color-on-surface);\n    margin: 0;\n    font-weight: 600;\n    display: flex;\n    align-items: center;\n    gap: 0.375rem;\n  }\n\n  .tc-section-title::before {\n    content: \'\';\n    width: 2px;\n    height: 0.875rem;\n    background: var(--gt-color-primary);\n    border-radius: 1px;\n  }\n\n  .tc-active-filters {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));\n    gap: 0.5rem;\n  }\n\n  .tc-filter-control {\n    display: flex;\n    flex-direction: column;\n    gap: 0.375rem;\n    padding: 0.5rem;\n    border-radius: 0.5rem;\n    background: var(--gt-color-surface);\n    border: 1px solid var(--gt-color-outline-variant);\n    position: relative;\n    transition: all 0.2s ease;\n  }\n\n  .tc-filter-control:hover {\n    transform: translateY(-1px);\n    box-shadow: 0 2px 6px rgba(0,0,0,0.08);\n  }\n\n  .tc-filter-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n  }\n\n  .tc-filter-label {\n    font: var(--gt-typescale-body-small);\n    color: var(--gt-color-on-surface);\n    font-weight: 500;\n  }\n\n  .tc-filter-description {\n    font: var(--gt-typescale-body-small);\n    color: var(--gt-color-on-surface-variant);\n    margin-top: -0.45rem;\n    margin-bottom: 0.25rem;\n    line-height: 1.25;\n  }\n\n  .tc-remove-filter-btn {\n    min-width: 1.25rem;\n    min-height: 1.25rem;\n    border-radius: 50%;\n    background: var(--gt-color-error-container);\n    color: var(--gt-color-on-error-container);\n    font-size: 0.75rem;\n    font-weight: bold;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    transition: all 0.2s ease;\n    cursor: pointer;\n  }\n\n  .tc-input {\n    display: flex;\n    flex-direction: row;\n    align-items: center;\n    width: 100%;\n    gap: 0.25rem;\n\n    input {\n      border: 1px solid var(--gt-color-outline);\n      outline: none;\n      border-radius: 0.25rem;\n      height: 1.75rem;\n      min-width: 2.5rem;\n      text-align: center;\n      font: var(--gt-typescale-body-small);\n      font-weight: 500;\n      background: var(--gt-color-surface);\n      color: var(--gt-color-on-surface);\n      transition: all 0.2s ease;\n      flex: 1;\n    }\n\n    input:focus {\n      border-color: var(--gt-color-primary);\n      box-shadow: 0 0 0 2px rgba(var(--gt-color-primary-rgb, 98, 0, 238), 0.12);\n    }\n\n    button {\n      min-width: 1.75rem;\n      min-height: 1.75rem;\n      border-radius: 0.25rem;\n      background: var(--gt-color-primary);\n      color: var(--gt-color-on-primary);\n      font-weight: 600;\n      font-size: 0.75rem;\n      transition: all 0.2s ease;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      cursor: pointer;\n    }\n  }\n\n  .tc-filter-management {\n    display: flex;\n    flex-direction: column;\n    gap: 0.5rem;\n    padding-top: 0.375rem;\n    border-top: 1px solid var(--gt-color-outline-variant);\n  }\n\n  .tc-add-filter-container {\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n  }\n\n  .tc-add-filter-select {\n    flex: 1;\n    min-height: 2rem;\n    padding: 0 0.5rem;\n    border-radius: 0.375rem;\n    border: 1px solid var(--gt-color-outline);\n    background: var(--gt-color-surface);\n    color: var(--gt-color-on-surface);\n    font: var(--gt-typescale-body-small);\n    cursor: pointer;\n    transition: all 0.2s ease;\n    \n    appearance: none;\n    -webkit-appearance: none;\n    -moz-appearance: none;\n    padding-left: 0.3rem;\n    background-repeat: no-repeat;\n    background-position: right center;\n    background-image: url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23666"><path d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z"></path></svg>\');\n    outline: none;\n  }\n\n  .tc-add-filter-select:focus {\n    border-color: var(--gt-color-primary);\n    box-shadow: 0 0 0 2px rgba(var(--gt-color-primary-rgb, 98, 0, 238), 0.12);\n  }\n\n  .tc-profile-container {\n    display: flex;\n    flex-direction: column;\n    gap: 0.5rem;\n    padding: 0.625rem;\n    border-radius: 0.5rem;\n    background: var(--gt-color-surface-variant);\n    border: 1px solid var(--gt-color-outline-variant);\n  }\n\n  .tc-profile-controls {\n    display: flex;\n    flex-direction: row;\n    align-items: center;\n    gap: 0.5rem;\n  }\n\n  .tc-profile-select-container {\n    flex: 1;\n    width: 100%;\n\n    select {\n      width: 100%;\n      min-height: 2rem;\n      padding: 0 0.5rem;\n      border-radius: 0.375rem;\n      border: 1px solid var(--gt-color-outline);\n      background: var(--gt-color-surface);\n      color: var(--gt-color-on-surface);\n      font: var(--gt-typescale-body-small);\n      transition: all 0.2s ease;\n      cursor: pointer;\n    \n      appearance: none;\n      -webkit-appearance: none;\n      -moz-appearance: none;\n      padding-left: 0.3rem;\n      background-repeat: no-repeat;\n      background-position: right center;\n      background-image: url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23666"><path d="M12 15.0006L7.75732 10.758L9.17154 9.34375L12 12.1722L14.8284 9.34375L16.2426 10.758L12 15.0006Z"></path></svg>\');\n      outline: none;\n    }\n\n    select:focus {\n      border-color: var(--gt-color-primary);\n      box-shadow: 0 0 0 2px rgba(var(--gt-color-primary-rgb, 98, 0, 238), 0.12);\n    }\n  }\n\n  .tc-filter-reset-btn {\n    min-width: 4rem;\n    min-height: 2rem;\n    padding: 0 0.75rem;\n    border-radius: 0.375rem;\n    background: var(--gt-color-secondary);\n    color: var(--gt-color-on-secondary);\n    font: var(--gt-typescale-body-small);\n    font-weight: 500;\n    transition: all 0.2s ease;\n    cursor: pointer;\n  }\n\n  .tc-view-toggle-btn {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 0.375rem;\n    min-height: 1.75rem;\n    padding: 0.375rem 0.625rem;\n    border-radius: 0.375rem;\n    background: linear-gradient(135deg, var(--gt-color-primary) 0%, var(--gt-color-secondary) 100%);\n    color: var(--gt-color-on-primary);\n    font: var(--gt-typescale-body-medium);\n    font-weight: 500;\n    transition: all 0.3s ease;\n    cursor: pointer;\n    overflow: hidden;\n    transform: translateY(0);\n  }\n  \n  .tc-view-toggle-btn.active {\n    background: linear-gradient(135deg, var(--gt-color-primary) 0%, var(--gt-color-secondary) 100%);\n    color: var(--gt-color-on-primary);\n    box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n    transform: translateY(-1px);\n  }\n\n  .tc-view-toggle-btn .tc-btn-icon {\n    width: 1rem;\n    height: 1rem;\n    opacity: 0.9;\n    transition: transform 0.3s ease;\n  }\n\n  .tc-view-toggle-btn.active .tc-btn-icon {\n    transform: rotate(180deg);\n  }\n\n  .tc-no-filters {\n    text-align: center;\n    color: var(--gt-color-on-surface-variant);\n    font: var(--gt-typescale-body-small);\n    font-style: italic;\n    padding: 1rem 0.5rem;\n    background: var(--gt-color-surface-variant);\n    border-radius: 0.375rem;\n    border: 1px dashed var(--gt-color-outline-variant);\n  }\n\n  @media (hover: hover) and (pointer: fine) {\n    .tc-input button:hover {\n      background: var(--gt-color-primary);\n      filter: brightness(1.1);\n      transform: scale(1.05);\n    }\n    \n    .tc-remove-filter-btn:hover {\n      background: var(--gt-color-error);\n      color: var(--gt-color-on-error);\n      transform: scale(1.1);\n    }\n    \n    .tc-filter-reset-btn:hover {\n      background: var(--gt-color-secondary);\n      filter: brightness(1.1);\n    }\n    \n    .tc-view-toggle-btn:hover {\n      background: linear-gradient(135deg, var(--gt-color-primary) 0%, var(--gt-color-secondary) 100%);\n      box-shadow: 0 2px 6px rgba(0,0,0,0.2);\n      transform: translateY(-1px) scale(1.01);\n    }\n    \n    .tc-view-toggle-btn.active:hover {\n      background: linear-gradient(135deg, var(--gt-color-primary) 0%, var(--gt-color-secondary) 100%);\n      box-shadow: 0 4px 8px rgba(0,0,0,0.2);\n      transform: translateY(-1px) scale(1.01);\n    }\n  }\n\n  @container tc-container (max-width: 20rem) {\n    .tc-active-filters {\n      grid-template-columns: 1fr;\n    }\n    \n    .tc-profile-controls {\n      flex-direction: column;\n    }\n    \n    .tc-filter-reset-btn {\n      width: 100%;\n    }\n  }\n\n  @container tc-container (min-width: 20rem) and (max-width: 35rem) {\n    .tc-active-filters {\n      grid-template-columns: repeat(2, 1fr);\n    }\n  }\n\n  @container tc-container (min-width: 35rem) {\n    .tc-active-filters {\n      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));\n    }\n  }\n\n  /* Animation for adding/removing filters */\n  .tc-filter-control {\n    animation: fadeIn 0.2s ease-out;\n  }\n\n  @keyframes fadeIn {\n    from {\n      opacity: 0;\n      transform: translateY(-5px) scale(0.98);\n    }\n    to {\n      opacity: 1;\n      transform: translateY(0) scale(1);\n    }\n  }\n',this.selectionList.appendChild(n),this._setupEventListeners(),this.observer&&this.observer.disconnect(),this.observer=new MutationObserver(this._handleMutations.bind(this)),this.observer.observe(this.selectionList,{childList:!0,subtree:!0}),Array.from(t.getFRDataMap()).forEach((([t,e])=>{if(this.customizableTargetList.includes(e.identifier)){if(!this.currentTarget.has(t)){const n=this.config.INITIAL_TARGET_FILTERS.find((t=>(t.name.endsWith(" Target")?t.name:t.name+" Target")===e.identifier))?.filter;if(n){const r={},i=[];this.availableFilters.forEach((t=>{void 0!==n[t.id]&&0!==n[t.id]&&(r[t.id]=n[t.id],i.push(t.id))})),this.currentTarget.set(t,{identifier:e.identifier,filter:r,activeFilters:i}),this._updateTargetData(t)}else this.currentTarget.set(t,{identifier:e.identifier,filter:{},activeFilters:[]})}const n=this.selectionList.querySelector(`.selection-list-item[data-uuid="${t}"]`);n&&!n.querySelector(".target-control-component")&&this._addTargetControlComponent(t)}})),e.updateLabels()}_addTargetControlComponent(t){const e=this.currentTarget.get(t);if(!e)return void console.warn(`Target data for UUID ${t} not found when trying to add control component.`);const r=this.selectionList.querySelector(`.selection-list-item[data-uuid="${t}"]`);if(!r)return void console.warn(`Parent element for UUID ${t} not found when trying to append control component.`);if(r.querySelector(".target-control-component"))return;const i=document.createElement("div");i.className="target-control-component tc-component-hidden",i.setAttribute("data-uuid",t),i.innerHTML=`\n      <div class="tc-container">\n        ${this._buildFiltersSection(e)}\n        ${this._buildProfileSection()}\n      </div>\n    `,r.appendChild(i),this._addAllEventListeners(i);const a=document.createElement("button");a.className="tc-view-toggle-btn",a.setAttribute("data-uuid",t),a.innerHTML=`\n      <svg class="tc-btn-icon" viewBox="0 0 24 24" fill="currentColor">\n        <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5a3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97c0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1c0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"/>\n      </svg>\n      <span>${n.getString("extension.target-customizer.tc-button.view","Pref. Adjustment")}</span>\n    `,a.addEventListener("click",(t=>{i&&(a.classList.toggle("active"),i.classList.toggle("tc-component-hidden"))})),r.querySelector(".sl-item-leading").insertBefore(a,r.querySelector(".sl-item-leading").firstChild),this._updateBaselineButton(t)}_buildFiltersSection(t){const e=t.activeFilters.length>0?t.activeFilters.map((e=>this._buildFilterControl(e,t))).join(""):`<div class="tc-no-filters">${n.getString("extension.target-customizer.tc-filter.no-filters","No filters active")}</div>`,r=this._buildAddFilterSelect(t.activeFilters);return`\n      <div class="tc-filters-section">\n        <h4 class="tc-section-title">${n.getString("extension.target-customizer.tc-filter.active","Active Filters")}</h4>\n        <div class="tc-active-filters">\n          ${e}\n        </div>\n        ${r}\n      </div>\n    `}_buildFilterControl(t,e){const r=this.availableFilters.find((e=>e.id===t));if(!r)return"";const i=e.filter[t]||0,a=n.getString(`extension.target-customizer.tc-label.${t}`,r.name),o=n.getString(`extension.target-customizer.tc-description.${t}`,r.description);return`\n      <div class="tc-filter-control" data-filter-id="${t}">\n        <div class="tc-filter-header">\n          <span class="tc-filter-label">${a}</span>\n          <button class="tc-remove-filter-btn" data-filter-id="${t}">×</button>\n        </div>\n        ${o?`<div class="tc-filter-description">${o}</div>`:""}\n        <div class="tc-input">\n          <input type="number" min="${"tilt"===t?-10:-20}" max="${"tilt"===t?10:20}" value="${i}" step="0.1" class="tc-input" data-type="${t}">\n          <button class="tc-input-btn-dec" data-target="${t}">−</button>\n          <button class="tc-input-btn-inc" data-target="${t}">+</button>\n        </div>\n      </div>\n    `}_buildAddFilterSelect(t){const e=this.availableFilters.filter((e=>!t.includes(e.id)));if(0===e.length)return"";const r=e.map((t=>{const e=n.getString(`extension.target-customizer.tc-label.${t.id}`,t.name);return`<option value="${t.id}">${e}</option>`})).join("");return`\n      <div class="tc-filter-management">\n        <div class="tc-add-filter-container">\n          <select class="tc-add-filter-select">\n            <option value="">${n.getString("extension.target-customizer.tc-filter.add-placeholder","Add a filter...")}</option>\n            ${r}\n          </select>\n        </div>\n      </div>\n    `}_buildProfileSection(){return`\n      <div class="tc-profile-container">\n        <h4 class="tc-section-title">${n.getString("extension.target-customizer.tc-profile.title","Filter Profiles")}</h4>\n        <div class="tc-profile-controls">\n          <div class="tc-profile-select-container">\n            <select class="tc-profile-select">\n              <option value="">\n                ${n.getString("extension.target-customizer.tc-profile.placeholder","Select filter profile")}\n              </option>\n            </select>\n          </div>\n          <button class="tc-filter-reset-btn">${n.getString("extension.target-customizer.tc-button.reset","Reset")}</button>\n        </div>\n      </div>\n    `}_setupEventListeners(){window.addEventListener("core:fr-target-added",this._handleTargetAdded.bind(this)),window.addEventListener("core:fr-target-removed",this._handleTargetRemoved.bind(this)),n.addObserver(this._updateLanguage.bind(this))}_handleTargetAdded(e){const n=e.detail.uuid,r=t.getFRData(n);if(r&&this.customizableTargetList.includes(r.identifier)){if(!this.currentTarget.has(n)){const t=this.config.INITIAL_TARGET_FILTERS.find((t=>(t.name.endsWith(" Target")?t.name:t.name+" Target")===r.identifier))?.filter;if(t){const e={},i=[];this.availableFilters.forEach((n=>{void 0!==t[n.id]&&0!==t[n.id]&&(e[n.id]=t[n.id],i.push(n.id))})),this.currentTarget.set(n,{identifier:r.identifier,filter:e,activeFilters:i}),this._updateTargetData(n)}else this.currentTarget.set(n,{identifier:r.identifier,filter:{},activeFilters:[]})}if(this.selectionList){const t=this.selectionList.querySelector(`.selection-list-item[data-uuid="${n}"]`);t&&!t.querySelector(".target-control-component")&&this._addTargetControlComponent(n)}}}_handleTargetRemoved(t){const e=t.detail.uuid;this.currentTarget.delete(e)}_addAllEventListeners(t){this.config.FILTER_PRESET.forEach((e=>{const n=document.createElement("option");n.value=e.name,n.textContent=e.name,t.querySelector(".tc-profile-select").appendChild(n)})),this._addInputEventListener(t),this._addFilterManagementEventListener(t),this._addSelectEventListener(t),this._addResetBtnEventListener(t)}_addInputEventListener(t){const n=t.querySelectorAll(".tc-input-btn-inc"),r=t.querySelectorAll(".tc-input-btn-dec"),i=t.querySelectorAll("input[type='number'].tc-input"),btnAction=(t,e)=>{const n=t.dataset.target,r=t.parentNode.querySelector(`input[data-type="${n}"]`),i=parseFloat(r.step)||.1,a=parseFloat(r.value)||0,o="inc"===e?(a+i).toFixed(1):(a-i).toFixed(1),l=parseFloat(r.min),s=parseFloat(r.max);r.value=Math.max(l,Math.min(s,parseFloat(o))),r.dispatchEvent(new Event("change",{bubbles:!0}))},setupLongPress=(t,e)=>{let n,r=!1;t.addEventListener("mousedown",(()=>{r=!0,btnAction(t,e),n=setInterval((()=>{r&&btnAction(t,e)}),150)}));const stopAction=()=>{r=!1,clearInterval(n)};t.addEventListener("mouseup",stopAction),t.addEventListener("mouseleave",stopAction)};n.forEach((t=>{t.addEventListener("click",(()=>btnAction(t,"inc"))),setupLongPress(t,"inc")})),r.forEach((t=>{t.addEventListener("click",(()=>btnAction(t,"dec"))),setupLongPress(t,"dec")})),i.forEach((t=>{t.addEventListener("click",(()=>{t.select()})),t.addEventListener("change",(()=>{const n=t.closest(".target-control-component").getAttribute("data-uuid"),r=t.dataset.type;let i=parseFloat(t.value);const a=parseFloat(t.min),o=parseFloat(t.max);i=isNaN(i)?this.currentTarget.get(n)?.filter?.[r]??0:Math.max(a,Math.min(o,i));const l=i.toFixed(1);if(t.value=l,this.currentTarget.has(n)){const t=this.currentTarget.get(n);this.currentTarget.set(n,{...t,filter:{...t.filter,[r]:l}}),this._updateTargetData(n),e.updateLabels()}else console.warn(`Target data for UUID ${n} not found during input change.`)}))}))}_addFilterManagementEventListener(t){const e=t.querySelector(".tc-add-filter-select");e&&e.addEventListener("change",(e=>{const n=e.target.value;if(n){const r=t.getAttribute("data-uuid");this._addFilter(r,n),e.target.value=""}})),t.addEventListener("click",(e=>{if(e.target.matches(".tc-remove-filter-btn")){const n=e.target.dataset.filterId,r=t.getAttribute("data-uuid");this._removeFilter(r,n)}}))}_addFilter(t,n){const r=this.currentTarget.get(t);r&&(r.activeFilters.includes(n)||(r.activeFilters.push(n),r.filter[n]=0,this._refreshFiltersSection(t),this._updateTargetData(t),e.updateLabels()))}_removeFilter(t,n){const r=this.currentTarget.get(t);if(!r)return;const i=r.activeFilters.indexOf(n);i>-1&&(r.activeFilters.splice(i,1),delete r.filter[n],this._refreshFiltersSection(t),this._updateTargetData(t),e.updateLabels())}_refreshFiltersSection(t){const e=this.selectionList.querySelector(`.target-control-component[data-uuid="${t}"]`),r=e.querySelector(".tc-filters-section"),i=this.currentTarget.get(t);r&&i&&(r.innerHTML=`\n        <h4 class="tc-section-title">${n.getString("extension.target-customizer.tc-filter.active","Active Filters")}</h4>\n        <div class="tc-active-filters">\n          ${i.activeFilters.length>0?i.activeFilters.map((t=>this._buildFilterControl(t,i))).join(""):`<div class="tc-no-filters">${n.getString("extension.target-customizer.tc-filter.no-filters","No filters active")}</div>`}\n        </div>\n        ${this._buildAddFilterSelect(i.activeFilters)}\n      `,this._addInputEventListener(e),this._addFilterManagementEventListener(e))}_addSelectEventListener(t){const n=t.querySelector("select.tc-profile-select");n.addEventListener("change",(()=>{const t=n.closest(".target-control-component").getAttribute("data-uuid"),r=n.value;if(""===r)return;const i=this.config.FILTER_PRESET.find((t=>t.name===r));if(!i)return void console.warn(`Profile ${r} not found in FILTER_PRESET.`);const a=this.currentTarget.get(t);if(!a)return;const o={},l=[];this.availableFilters.forEach((t=>{void 0!==i.filter[t.id]&&0!==i.filter[t.id]&&(o[t.id]=i.filter[t.id],l.push(t.id))})),this.currentTarget.set(t,{...a,filter:o,activeFilters:l}),this._refreshComponent(t),this._updateTargetData(t),e.updateLabels()}))}_addResetBtnEventListener(t){const n=t.querySelector(".tc-filter-reset-btn");n.addEventListener("click",(()=>{const r=n.closest(".target-control-component").getAttribute("data-uuid"),i=this.currentTarget.get(r);if(!i)return;this.currentTarget.set(r,{...i,filter:{},activeFilters:[]});t.querySelector("select.tc-profile-select").value="",this._refreshComponent(r),this._updateTargetData(r),e.updateLabels()}))}_refreshComponent(t){const e=this.selectionList.querySelector(`.target-control-component[data-uuid="${t}"]`),n=this.currentTarget.get(t);e&&n&&this._refreshFiltersSection(t)}_updateTargetData(e){const n=this.currentTarget.get(e);if(void 0===n)return;const r=t.getFRData(e);if(void 0===r)return;const i=new Equalizer,a=n.activeFilters.filter((t=>"tilt"!==t)).map((t=>{const e=this.availableFilters.find((e=>e.id===t));return e?{type:e.type,freq:e.freq,q:e.q,gain:n.filter[t]||0}:null})).filter((t=>null!==t)),o={};Object.keys(r.channels).forEach((t=>{if(r.channels[t]){let e=[];e=""===r.dispSuffix?i.applyFilters(r.channels[t].data,a):i.applyFilters(r.meta?.extensionData?.ogChannels[t].data,a);const l=n.filter.tilt||0,s=e.map(((t,e)=>[t[0],t[1]+l*Math.log2(t[0])]));o[t]={data:s,metadata:{...r.channels[t].metadata}}}}));let l="";n.activeFilters.forEach((t=>{const e=this.availableFilters.find((e=>e.id===t)),r=n.filter[t];e&&0!==parseFloat(r)&&(l+="tilt"===t?`${e.name}: ${`${r}`.replace(".0","")}dB/oct `:`${e.name}: ${`${r}`.replace(".0","")}dB `)}));const s={dispSuffix:""!==l?`(${l.trimEnd()})`:""};""===r.dispSuffix&&void 0===r.meta?.extensionData?.ogChannels&&(s.meta={...r.meta,extensionData:{...r.meta?.extensionData,ogChannels:r.channels}}),t.updateFRDataWithRawData(e,o,s)}_updateBaselineButton(n){const i=this.selectionList.querySelector(`.selection-list-item[data-uuid="${n}"]`);if(!i)return void console.warn(`Parent element for UUID ${n} not found when trying to update baseline button.`);const a=i.querySelector(".sl-button.baseline");if(!a)return void console.warn(`Baseline button not found for UUID ${n}.`);const o=document.createElement("button");o.className="sl-button baseline",o.setAttribute("title","Set as tilted baseline"),o.innerHTML=`${r.Icon("wave")}`,a.parentNode.replaceChild(o,a),o.addEventListener("click",(i=>{i.preventDefault();const a=i.currentTarget,o=Array.from(a.classList).find((t=>["tilted","flat"].includes(t)))||"disabled",l=this.currentTarget.get(n).filter;"disabled"===o?0!==l.tilt?e.updateBaselineData(!0,{uuid:n,channelData:t.getFRData(n).meta?.extensionData?.ogChannels.AVG.data}):e.updateBaselineData(!0,{uuid:n}):"tilted"===o?e.updateBaselineData(!0,{uuid:n}):"flat"===o?e.updateBaselineData(!1,{uuid:n}):console.error(`Unknown button status: ${o}`),this.selectionList.querySelectorAll(".sl-button.baseline").forEach((t=>{t===a?"disabled"===o?0!==l.tilt?(t.innerHTML=r.Icon("tilted"),t.classList.add("active","tilted"),t.setAttribute("title","Set as flat baseline")):(t.innerHTML=r.Icon("flatline"),t.classList.remove("tilted"),t.classList.add("active","flat"),t.setAttribute("title","Reset Baseline")):"tilted"===o?(t.innerHTML=r.Icon("flatline"),t.classList.remove("tilted"),t.classList.add("active","flat"),t.setAttribute("title","Reset Baseline")):"flat"===o?(t.innerHTML=r.Icon("wave"),t.classList.remove("active","flat","tilted"),t.setAttribute("title","Set as tilted baseline")):console.error(`Unknown button status: ${o}`):"disabled"===o&&(t.classList.remove("active","flat","tilted"),t.setAttribute("title","Set Baseline"),t.innerHTML=r.Icon("wave"))}))}))}_handleMutations(t,e){for(const e of t)"childList"===e.type&&e.addedNodes.forEach((t=>{if(t.nodeType===Node.ELEMENT_NODE&&t.matches(".selection-list-item")){const e=t.getAttribute("data-uuid");e&&this.currentTarget.has(e)&&!t.querySelector(".target-control-component")&&this._addTargetControlComponent(e)}else if(t.nodeType===Node.ELEMENT_NODE&&t.querySelector){const e=t.querySelector(".selection-list-item");if(e){const t=e.getAttribute("data-uuid");t&&this.currentTarget.has(t)&&!e.querySelector(".target-control-component")&&this._addTargetControlComponent(t)}}}))}_updateLanguage(){const t=this.selectionList.querySelectorAll(".tc-view-toggle-btn");t&&t.forEach((t=>{t.innerHTML=`\n          <svg class="tc-btn-icon" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5a3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97c0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1c0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"/>\n          </svg>\n          <span>${n.getString("extension.target-customizer.tc-button.view","Pref. Adjustment")}</span>\n        `}));const e=this.selectionList.querySelectorAll(".target-control-component");e&&e.forEach((t=>{const e=t.getAttribute("data-uuid");this._refreshComponent(e)}))}_getCustomizableTargetList(){return this.config.CUSTOMIZABLE_TARGETS.map((t=>t.endsWith(" Target")?t:t+" Target"))}}export{i as EXTENSION_METADATA,TargetCustomizer as default};
//# sourceMappingURL=main.js.map
